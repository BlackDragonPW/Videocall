<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Video Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0B141A;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        /* Join Screen */
        .join-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #075E54, #128C7E);
        }

        .join-box {
            background: #202C33;
            border-radius: 20px;
            padding: 30px 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .join-box h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #25D366;
        }

        .join-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            background: #2A3942;
            color: white;
            font-size: 16px;
        }

        .join-box input::placeholder {
            color: #8696A0;
        }

        .join-box button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 10px;
            background: #25D366;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .join-box button:last-child {
            background: #128C7E;
        }

        .join-box button:active {
            transform: scale(0.98);
        }

        .room-info {
            margin-top: 20px;
            padding: 15px;
            background: #2A3942;
            border-radius: 10px;
            display: none;
        }

        .room-info.active {
            display: block;
        }

        .room-link {
            background: #0B141A;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }

        /* Call Screen */
        .call-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #0B141A;
        }

        .videos {
            flex: 1;
            position: relative;
            background: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #25D366;
            background: #333;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #202C33;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #2A3942;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .control-btn.red {
            background: #f44336;
        }

        .control-btn.green {
            background: #25D366;
        }

        .chat-area {
            height: 200px;
            background: #202C33;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #2A3942;
            border-radius: 10px;
            max-width: 80%;
            font-size: 14px;
        }

        .message.outgoing {
            background: #005C4B;
            margin-left: auto;
        }

        .message.system {
            background: #374248;
            text-align: center;
            font-style: italic;
            margin: 5px auto;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            gap: 10px;
            background: #2A3942;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background: #202C33;
            color: white;
        }

        .chat-input button {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            background: #25D366;
            color: white;
            font-weight: bold;
        }

        .status {
            text-align: center;
            padding: 10px;
            background: #202C33;
            color: #8696A0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Join Screen -->
    <div id="joinScreen" class="join-screen">
        <div class="join-box">
            <h2>ðŸ“± Simple Video Chat</h2>
            <input type="text" id="nameInput" placeholder="Your Name" value="User">
            <input type="text" id="roomInput" placeholder="Room Name" value="test123">
            <button id="createBtn">Create Room</button>
            <button id="joinBtn">Join Room</button>
            
            <div id="roomInfo" class="room-info">
                <p>Share this link:</p>
                <div id="roomLink" class="room-link"></div>
                <button id="copyBtn">Copy Link</button>
            </div>
        </div>
    </div>

    <!-- Call Screen -->
    <div id="callScreen" class="call-screen" style="display: none;">
        <div class="status" id="statusText">Connecting...</div>
        
        <div class="videos">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div class="controls">
            <button class="control-btn" id="muteBtn">ðŸŽ¤</button>
            <button class="control-btn" id="videoBtn">ðŸ“¹</button>
            <button class="control-btn red" id="endCallBtn">ðŸ“ž</button>
        </div>

        <div class="chat-area">
            <div class="messages" id="messages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message...">
                <button id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // State
        let peer = null;
        let currentCall = null;
        let localStream = null;
        let conn = null;
        let userName = 'User';
        let roomId = 'test123';
        let isMuted = false;
        let isVideoOff = false;

        // DOM elements
        const joinScreen = document.getElementById('joinScreen');
        const callScreen = document.getElementById('callScreen');
        const nameInput = document.getElementById('nameInput');
        const roomInput = document.getElementById('roomInput');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const roomInfo = document.getElementById('roomInfo');
        const roomLink = document.getElementById('roomLink');
        const copyBtn = document.getElementById('copyBtn');
        const statusText = document.getElementById('statusText');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const muteBtn = document.getElementById('muteBtn');
        const videoBtn = document.getElementById('videoBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const messages = document.getElementById('messages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Initialize Peer
        function initPeer() {
            return new Promise((resolve) => {
                peer = new Peer({
                    config: config
                });

                peer.on('open', (id) => {
                    console.log('Peer ID:', id);
                    addMessage('system', 'Connected to server');
                    resolve();
                });

                peer.on('error', (error) => {
                    console.error('Peer error:', error);
                    addMessage('system', 'Error: ' + error.type);
                });

                peer.on('call', (call) => {
                    if (confirm('Incoming call. Answer?')) {
                        if (localStream) {
                            call.answer(localStream);
                            setupCall(call);
                        }
                    } else {
                        call.close();
                    }
                });

                peer.on('connection', (connection) => {
                    setupDataConnection(connection);
                });
            });
        }

        // Get media
        async function getMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                localVideo.srcObject = localStream;
                return true;
            } catch (error) {
                console.error('Media error:', error);
                alert('Please allow camera and microphone access');
                return false;
            }
        }

        // Create room
        createBtn.addEventListener('click', async () => {
            userName = nameInput.value.trim() || 'User';
            roomId = roomInput.value.trim() || 'test123';
            
            // Initialize Peer
            await initPeer();
            
            // Show room info
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            roomLink.textContent = shareUrl;
            roomInfo.classList.add('active');
            
            addMessage('system', `Room created: ${roomId}`);
        });

        // Join room
        joinBtn.addEventListener('click', async () => {
            userName = nameInput.value.trim() || 'User';
            
            // Check URL for room
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room') || roomInput.value.trim() || 'test123';
            
            // Get media first
            const mediaSuccess = await getMedia();
            if (!mediaSuccess) return;
            
            // Initialize Peer
            await initPeer();
            
            // Connect to peer
            conn = peer.connect(roomId);
            setupDataConnection(conn);
            
            // Make call
            currentCall = peer.call(roomId, localStream);
            setupCall(currentCall);
            
            // Show call screen
            joinScreen.style.display = 'none';
            callScreen.style.display = 'flex';
            statusText.textContent = 'Calling...';
        });

        // Setup call
        function setupCall(call) {
            call.on('stream', (remoteStream) => {
                remoteVideo.srcObject = remoteStream;
                statusText.textContent = 'Connected';
                addMessage('system', 'âœ… Call connected');
            });

            call.on('close', () => {
                statusText.textContent = 'Call ended';
                remoteVideo.srcObject = null;
            });

            call.on('error', (err) => {
                console.error('Call error:', err);
                statusText.textContent = 'Call failed';
            });
        }

        // Setup data connection
        function setupDataConnection(connection) {
            conn = connection;
            
            connection.on('open', () => {
                console.log('Data connection open');
                
                // Send user info
                connection.send({
                    type: 'user',
                    name: userName,
                    action: 'join'
                });
            });

            connection.on('data', (data) => {
                if (data.type === 'user') {
                    if (data.action === 'join') {
                        addMessage('system', `ðŸ‘¤ ${data.name} joined`);
                    }
                } else if (data.type === 'chat') {
                    addMessage('incoming', data.message, data.name);
                }
            });

            connection.on('close', () => {
                addMessage('system', 'ðŸ‘‹ User left');
            });
        }

        // Add message to chat
        function addMessage(type, text, sender = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            
            if (type === 'incoming' && sender) {
                msgDiv.innerHTML = `<b>${sender}:</b> ${text}`;
            } else if (type === 'system') {
                msgDiv.textContent = text;
            } else {
                msgDiv.textContent = text;
            }
            
            messages.appendChild(msgDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // Send chat message
        sendBtn.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (text && conn && conn.open) {
                conn.send({
                    type: 'chat',
                    message: text,
                    name: userName
                });
                addMessage('outgoing', text);
                chatInput.value = '';
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // Mute audio
        muteBtn.addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isMuted = !isMuted;
                    audioTrack.enabled = !isMuted;
                    muteBtn.textContent = isMuted ? 'ðŸ”‡' : 'ðŸŽ¤';
                }
            }
        });

        // Toggle video
        videoBtn.addEventListener('click', () => {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoOff = !isVideoOff;
                    videoTrack.enabled = !isVideoOff;
                    videoBtn.textContent = isVideoOff ? 'ðŸš«' : 'ðŸ“¹';
                }
            }
        });

        // End call
        endCallBtn.addEventListener('click', () => {
            if (currentCall) {
                currentCall.close();
            }
            if (conn) {
                conn.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
            }
            
            callScreen.style.display = 'none';
            joinScreen.style.display = 'flex';
            roomInfo.classList.remove('active');
        });

        // Copy link
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(roomLink.textContent);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy Link';
            }, 2000);
        });

        // Auto-join from URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                roomInput.value = roomParam;
            }
        });
    </script>
</body>
</html>
